<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks</title>
    
    <script src="https://unpkg.com/htmx.org@1.9.12" integrity="sha384-ujb1lZYygJmzgSwoxRggbCHcjc0rB2XoQrxeTUQyRjrOnlCoYta87iKBWq3EsdM2" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap');
        .font-poppins {
          font-family: 'Poppins', sans-serif;
        }
    </style>
</head>
<body class='bg-gradient-to-r from-[#5B073A] to-[#673252] font-poppins'>
    {% if user.is_authenticated %}


    <section id="root">
        <nav class="flex flex-row bg-gradient-to-r from-[#5B073A] to-[#673252] p-8 mb-8">
            <div class="container flex justify-between items-center">
                <div class="text-white font-medium text-center w-full ">
                  <p class="text-2xl">Ulaş Gülhan's ToDo List</p>
                </div>
            </div>
            <button type="submit" class='text-white hover:text-gray-300' hx-post="{% url 'logout' %}" onclick="reloadPage()">Logout</button>
        </nav>
        

        <div class='flex flex-col items-center justify-center'>
            <div class='flex flex-col items-center justify-center w-2/4'>
            <form id="add-task-form" hx-post="{% url 'task-create' %}" hx-trigger="submit" hx-target="#task-list" hx-swap="beforeend" class="w-full flex">
                <input type="text" name="task" placeholder="Enter task" class="mb-2 flex-grow px-4 py-2 border rounded mr-2 h-10">
                <button type="submit" class="bg-[#3C46FF] hover:bg-[#2B31A6] text-white font-medium py-2 px-4 rounded h-10">&#43; Add Task</button>
            </form>
            </div>
        </div>

        <div class='flex flex-row items-center justify-center'>
            <div class="w-2/4 bg-[#FFFFFF] flex justify-center border-[#EDEAE9] border-b">
                <button id='activeTasksBtn' onclick="fetchActiveTasks()" class="my-2 mr-4 border-2 border-[#3C46FF] hover:bg-[#3C46FF] hover:text-white font-medium py-2 px-4 rounded">&#9733; Active Tasks</button>
                <button id="completedTasksBtn"  onclick="fetchCompletedTasks()" class="my-2 border-2 border-[#2BA470] hover:bg-[#2BA470] hover:text-white font-medium py-2 px-4 rounded">&#10004; Completed Tasks</button>
            </div>
        </div>
        
        <div class="flex flex-col items-center justify-center">
            <div id="task-list" class="w-2/4">
        
            </div>
        </div>


    </section>
    {% else %}


    <div class="flex flex-col justify-center items-center h-screen bg-[url('static/img/login.svg')] bg-cover bg-center">
        <p class='mb-4 text-white font-medium text-3xl'>Welcome!</p>
        <div class="bg-[#F4F5F7] p-8 rounded shadow-inner">
            <p id="formTitle" class="flex justify-center mb-8">Login to your account</p>
            <div class="flex justify-center mb-8">

            <button onclick="showLoginForm()" class="mr-4 px-4 py-2 bg-[#3C46FF] text-white rounded">Login</button>
            <button onclick="showRegisterForm()" class="px-4 py-2 bg-[#3C46FF] text-white rounded">Register</button>

            </div>
            <div id="registerError" style="display: block; color: red;"></div>
            <div id="loginForm">
                <h1>Login</h1>
                <form hx-post="{% url 'login' %}" onsubmit="reloadPage()">
                    <input type="text" name="username" placeholder="Username" required class="mb-2 px-4 py-2 border border-gray-300 rounded w-full"><br>
                    <input type="password" name="password" placeholder="Password" required class="mb-2 px-4 py-2 border border-gray-300 rounded w-full"><br>
                    <button type="submit" class="px-4 py-2 bg-[#3C46FF] text-white rounded w-full">Login</button>
                </form>
            </div>
            <div id="registerSuccess" style="display: none;">Registration successful. Redirecting to login...</div>
            <div id="registerForm" style="display: none;">
                <h1>Register</h1>
                <form hx-post="{% url 'register' %}" onsubmit="submitRegisterForm()">
                    <input type="text" id="registerUsername" name="username" placeholder="Username" required class="mb-2 px-4 py-2 border border-gray-300 rounded w-full"><br>
                    <input type="email" name="email" placeholder="Email" required class="mb-2 px-4 py-2 border border-gray-300 rounded w-full"><br>
                    <input type="password" name="password" placeholder="Password" required class="mb-2 px-4 py-2 border border-gray-300 rounded w-full"><br>
                    <button type="submit" class="px-4 py-2 bg-[#3C46FF] text-white rounded w-full">Register</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</body>
<script>

    function submitRegisterForm() {
        event.preventDefault();
        var username = document.getElementById("registerUsername").value;
        fetch("/auth/register/", {
            method: 'POST',
            body: JSON.stringify({username: username}),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.status === 204) {
                getLoginAfterRegister()
                document.getElementById("registerError").style.display = "none";
                console.log(response.error, response.statusText)
            } else if (response.status === 406) {
                response.json().then(data => {
                    document.getElementById("registerError").innerText = data.error;
                    document.getElementById("registerError").style.display = "block";
                    document.getElementById('registerSuccess').style.display = 'none'; 
                    
                });
            } else {
                console.error('Error:', response.statusText);
            }
        });
        return false;
    }
    document.body.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
    });
    
    document.body.addEventListener('htmx:afterRequest', (event) => {
        fetchActiveTasks()
        document.querySelector("input[name='task']").value = '';
    });

    document.addEventListener('DOMContentLoaded', () => {
        const registerForm = document.querySelector("#registerForm");
        if (registerForm) {
            registerForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                try {
                    await getLoginAfterRegister();
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        } else {
            console.error("Element with ID 'registerForm' not found.");
        }
    });

    function reloadPage() {
        setTimeout(() => {
            location.reload();
        }, 1500);
    }

    function getLoginAfterRegister() {
        console.log("getLoginAfterRegister function called");
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('registerSuccess').style.display = 'block'; 
        setTimeout(() => { showLoginForm(); }, 1500); 
    }

    function fetchTasks(url) {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tasksContainer = document.getElementById('task-list');
                tasksContainer.innerHTML = '';
                data.tasks.forEach(task => {
                    const taskDiv = document.createElement('div');
                    taskDiv.classList.add('flex', 'items-center', 'space-x-4', 'flex', 'flex-wrap', 'whitespace-normal', 'break-words', 'justify-between', 'w-full', 'bg-[#FFFFFF]', 'hover:bg-[#F8F7F7]', 'border-[#EDEAE9]', 'border-b');

                    const completeButton = document.createElement('button');
                    completeButton.innerHTML = '&#10004;';
                    completeButton.classList.add('complete-btn', 'text-[#363639]', 'border-2', 'border-[#363639]', 'rounded-full', 'w-7', 'h-7', 'flex', 'items-center', 'justify-center', 'hover:bg-[#E6F8F1]', 'hover:border-[#60A688]', 'hover:text-[#60A688]', 'ml-4');
                    if (task.is_complete) {
                        completeButton.classList.remove('border-[#363639]');
                        completeButton.classList.add('bg-[#E6F8F1]', 'border-[#60A688]', 'text-[#60A688]', 'hover:bg-transparent', 'hover:border-[#363639]', 'hover:text-[#363639]');
                    }
                    completeButton.addEventListener('click', () => {
                        if (!task.is_complete) {
                            patchTaskComplete(task.id)
                                .then(() => {
                                    fetchActiveTasks();
                                    completeButton.classList.add('bg-[#1EBB8C]', 'text-white');
                                });
                        } else {
                            patchTaskComplete(task.id)
                                .then(() => {
                                    fetchCompletedTasks();
                                    completeButton.classList.remove('bg-[#1EBB8C]', 'text-white');
                                });
                        }
                    });

                    const taskElement = document.createElement('p');
                    taskElement.textContent = task.task;
                    taskElement.classList.add('text-left', 'flex-grow', 'max-w-[calc(100%-14rem)]', 'flex', 'items-center', 'min-h-16');
                    if (task.is_complete) {
                        taskElement.style.textDecoration = 'line-through';
                        taskElement.style.color = 'text-[#363639]';
                    }

                    taskElement.addEventListener('dblclick', () => {
                        const editableTaskElement = document.createElement('input');
                        editableTaskElement.type = 'text';
                        editableTaskElement.value = task.task;
                        editableTaskElement.classList.add('flex-grow', 'mb-2', 'px-4', 'py-2', 'border', 'rounded');
                        
                        editableTaskElement.addEventListener('blur', () => {
                            const updatedTask = editableTaskElement.value.trim();
                            if (updatedTask !== task.task) {
                                patchTaskUpdate(task.id, updatedTask)
                                    .then(() => fetchActiveTasks());
                            }
                            taskDiv.replaceChild(taskElement, editableTaskElement);
                        });
                    
                        editableTaskElement.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter') {
                                editableTaskElement.blur();
                            }
                        });
                    
                        taskDiv.replaceChild(editableTaskElement, taskElement);
                        editableTaskElement.focus();
                    });
    
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '&#10006; &nbsp; Delete';
                    deleteButton.classList.add('hover:text-[#D93256]', 'text-[#EB7586]', 'font-bold', 'py-2', 'px-4', 'rounded');
                    deleteButton.addEventListener('click', () => {
                        patchTaskDelete(task.id);
                        tasksContainer.removeChild(taskDiv);
                    });

                    const hr = document.createElement('hr');
                    hr.classList.add('border', 'border-[#EDEAE9]');

                    taskDiv.appendChild(completeButton);
                    taskDiv.appendChild(taskElement);
                    taskDiv.appendChild(deleteButton);
                    taskDiv.appendChild(hr);

                    tasksContainer.appendChild(taskDiv);


                });
            });
    }
    function patchTaskDelete(taskId) {
        fetch(`/api/tasks/delete/${taskId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            console.log('Task patched successfully');
        })
        .catch(error => {
            console.error('There was a problem with the patch request:', error);
        });
    }
    function patchTaskComplete(taskId) {
        return fetch(`/api/tasks/complete/${taskId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            console.log('Task patched successfully');
        })
        .catch(error => {
            console.error('There was a problem with the patch request:', error);
        });
    }

    function patchTaskUpdate(taskId, updatedTask) {
        return fetch(`/api/tasks/update/${taskId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ task: updatedTask })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            console.log('Task updated successfully');
        })
        .catch(error => {
            console.error('There was a problem with the patch request:', error);
        });
    }
    
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function showLoginForm() {
        document.getElementById('formTitle').innerText = 'Login to your account';
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('registerSuccess').style.display = 'none';
    }

    function loginSuccess(){
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('loginSuccess').style.display = 'block';
    }

    function showRegisterForm() {
        document.getElementById('formTitle').innerText = 'Create an account';
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('registerSuccess').style.display = 'none';
        document.getElementById('registerError').style.display = 'none';
    }

    function fetchCompletedTasks() {
        fetchTasks('/api/tasks/completed/');
        document.getElementById('completedTasksBtn').classList.add('bg-[#2BA470]', 'text-white');
        document.getElementById('completedTasksBtn').classList.remove('text-black');
        document.getElementById('activeTasksBtn').classList.remove('bg-[#3C46FF]', 'text-white');
        document.getElementById('activeTasksBtn').classList.add('text-black');
    }

    function fetchActiveTasks() {
        fetchTasks('/api/tasks/');
        document.getElementById('activeTasksBtn').classList.add('bg-[#3C46FF]', 'text-white');
        document.getElementById('activeTasksBtn').classList.remove('text-black');
        document.getElementById('completedTasksBtn').classList.remove('bg-[#2BA470]', 'text-white');
        document.getElementById('completedTasksBtn').classList.add('text-black');
    }
    window.addEventListener('load', fetchActiveTasks);
    window.addEventListener('load', fetchActiveTasks);
</script>

</html>


